// SONARQUBE + Depcheck + OWASP ZAP CI/CD TEMPLATE
// Pipeline script for Windows environment using PowerShell
// Handles Node.js app deployment with Docker Compose
//This is a pipeline that pulls, scans using SonarQube and deploys the application to a remote Windows server.
pipeline {
    agent {
        label 'remote-server-agent'
    }

    // Trigger Configuration
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.ref'],
                [key: 'commit', value: '$.after'],
                [key: 'author', value: '$.commits[0].author.name']
            ],
            causeString: 'Triggered by commit on $ref by $author',
            token: 'dwinzoBetaOrgDwinzoDev',
            printContributedVariables: true,
            printPostContent: true,
            regexpFilterText: '$ref',
            regexpFilterExpression: '^refs/heads/main$'
        )
    }

    // Environment Variables
    environment {
        GIT_CREDENTIALS = credentials('ramkumarp') // Git credentials for repository access
        SNYK_TOKEN = credentials('snyk-token')     // Snyk API token
    }

    stages {
        stage('Source') {
            steps {
                script {
                    cleanWs(deleteDirs: true, disableDeferredWipeout: true)

                    powershell '''
                        Write-Host "Starting source stage..."
                    '''

                    // Checkout source code from Git repository
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: 'http://185.100.212.76:7776/Dwinzo-Beta/Dwinzo_dev.git',
                            credentialsId: env.GIT_CREDENTIALS
                        ]]
                    ])

                    powershell '''
                        Write-Host "Source checkout completed successfully"
                        dir
                    '''
                }
            }
        }

        stage('Dependency Check') {
            steps {
                script {
                    powershell '''
                        Write-Host "Navigating to project directory..."
                        cd app  # Replace 'app' with the correct subdirectory if needed

                        Write-Host "Checking for outdated dependencies..."

                        # Install npm-check-updates globally if not already installed
                        npm install -g npm-check-updates

                        # Check for outdated dependencies
                        ncu

                        Write-Host "Auditing dependencies for vulnerabilities..."

                        # Run npm audit to check for security issues
                        npm audit
                    '''
                }
            }
        }

        stage('Security Scan with Snyk') {
            steps {
                script {
                    powershell '''
                        Write-Host "Navigating to project directory..."
                        cd app  # Replace 'app' with the correct subdirectory if needed

                        Write-Host "Installing Snyk CLI globally..."
                        npm install -g snyk

                        Write-Host "Authenticating Snyk..."
                        snyk auth $env:SNYK_TOKEN

                        Write-Host "Running Snyk test for security vulnerabilities..."
                        snyk test

                        Write-Host "Monitoring project with Snyk..."
                        snyk monitor
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    powershell '''
                        Write-Host "Cleaning existing Docker resources..."

                        # Check if the main container exists and remove it
                        $containerExists = docker ps -a -q -f name="$env:MAIN_CONTAINER"
                        if ($containerExists) {
                            Write-Host "Stopping and removing existing container: $env:MAIN_CONTAINER"
                            docker stop $env:MAIN_CONTAINER
                            docker rm $env:MAIN_CONTAINER
                        } else {
                            Write-Host "Container $env:MAIN_CONTAINER not found, skipping stop and remove."
                        }

                        Write-Host "Currently existing containers:"
                        docker ps -a
                        dir
                    '''

                    powershell '''
                        Write-Host "Starting Docker Compose build..."
                        $env:COMPOSE_CONVERT_WINDOWS_PATHS=1
                        docker-compose build --no-cache
                        dir
                    '''
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    powershell '''
                        Write-Host "Generating sonar-project.properties..."

                        $sonarProps = @"
                        sonar.projectKey=Dwinzo_Beta_Project_001
                        sonar.projectName=Dwinzo_Beta_Project
                        sonar.projectVersion=1.0.0
                        sonar.projectDescription=This is a sample project for Dwinzo Beta.
                        sonar.sources=./app/
                        sonar.language=js
                        sonar.javascript.lcov.reportPaths=coverage/lcov.info
                        "@

                        Set-Content -Path "sonar-project.properties" -Value $sonarProps

                        Write-Host "Running SonarScanner..."
                        sonar-scanner
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    powershell '''
                        Write-Host "Starting deployment with Docker Compose..."
                        $env:COMPOSE_CONVERT_WINDOWS_PATHS=1
                        docker compose up -d

                        Start-Sleep -Seconds 10

                        # Verify that the main container is running
                        $mainContainer = docker ps -q -f name="$env:MAIN_CONTAINER"
                        if (-not $mainContainer) {
                            Write-Error "Main application container ($env:MAIN_CONTAINER) not found"
                            exit 1
                        }

                        Write-Host "Application deployed successfully!"
                        Write-Host "Main Container ID: $mainContainer"
                        Write-Host "Main Container Logs:"
                        docker logs $mainContainer

                        Write-Host "Currently running containers:"
                        docker ps
                        dir
                    '''
                }
            }
        }
    }

    post {
        success {
            powershell '''
                Write-Host "Pipeline completed successfully!"
                Write-Host "Build Number: $env:BUILD_NUMBER"
                Write-Host "Workspace: $env:WORKSPACE"
                Write-Host "Triggered by commit: $env:commit"
                Write-Host "Author: $env:author"
            '''
        }

        failure {
            powershell '''
                Write-Host "Pipeline failed!"
                Write-Host "Please check the logs for details"
                Write-Host "Triggered by commit: $env:commit"
                Write-Host "Author: $env:author"

                Write-Host "Container status:"
                docker ps -a
            '''
        }

        always {
            cleanWs(deleteDirs: true, disableDeferredWipeout: true)
        }
    }
}